**`describe/it`** names so you can implement with **Vitest/Jest**, **@testing-library/react**, and **supertest/Request** for API routes.

---

# Test Stack (recommended)

* **Runner**: Vitest (fast) or Jest
* **React**: @testing-library/react + jsdom
* **API**: supertest or native `Request`/`Response` (Web Fetch API)
* **Property-based**: fast-check (for IDs/time conversions)
* **DB strategy**:

  * **Unit**: mock Prisma client
  * **Integration**: dedicated test DB (Postgres) via docker, run migrations before suite

Folder layout:

```
/tests
  /unit
  /integration
  /components
  /middleware
  /e2e (optional)
```

---

# Unit Tests — Pure Libraries

## `src/lib/ids.ts`

**describe('genExternalId')**

* it('generates prefix T by default or custom')
* it('is URL-safe and uppercase')
* it('collides extremely rarely across 10k generations')  *(probabilistic check)*
* it('length is stable (e.g., "T-XXXXXXXX")')

## `src/lib/serialize.ts`

**describe('toPlain')**

* it('converts Prisma Decimal to number')
* it('converts Date to ISO string')
* it('keeps primitive values unchanged')
* it('handles nested arrays/objects with Decimals')
* it('is idempotent on already-plain data')

## `src/lib/excel.ts`

**describe('loadXlsx / mapRow')**

* it('maps required Task column to title; skips row if missing')
* it('merges description + Acceptance Criteria + Commands/How to Run into description (with headings)')
* it('maps Est. Time (min) → seconds (minutes * 60)')
* it('parses XP to integer; ignores non-numeric')
* it('maps Priority strings and aliases (L/M/H/URGENT/P1)')
* it('parses dependency list by comma/space/semicolon to string[]')
* it('upper/lower/mixed-case headers are accepted (case-insensitive)')
* it('sheet name used as mainTaskTitle; falls back to filename without extension')
* it('ignores completely empty sheets')
* it('handles multiple sheets in a workbook')
* it('trims whitespace from all cell values')
* it('handles extremely long description fields without truncation')
* it('returns [] rows for empty sheet but emits default mainTaskTitle (fallback)')

**Property-based**

* it('minute→second conversion invariant: seconds % 60 == 0 for integer minutes')
* it('dependency parsing never returns empty-string elements')
* it('priority mapping only returns allowed enums or undefined')

---

# Unit Tests — API Contracts (without DB, Prisma mocked)

## `/api/tasks (POST|PATCH)`

**describe('tasks route validation')**

* POST it('creates task with externalId auto-generated when missing')
* POST it('accepts user-specified externalId and preserves it')
* POST it('defaults state to empty string')
* PATCH it('moving to "Done" column sets closedAt; leaving Done unsets closedAt')
* PATCH it('accepts startAt/endAt strings (ISO) and stores them')
* PATCH it('accepts estimatedSec, xp, notes, status, priority, dependencyExternalIds')
* PATCH it('generates externalId if cleared/empty')
* it('rejects unknown fields (optional if you add validation)')

## `/api/subtasks (POST|PATCH)`

* POST it('creates subtask with autogenerated externalId when missing')
* POST it('accepts provided externalId')
* PATCH it('completed=true sets closedAt; completed=false clears closedAt')
* PATCH it('updates description/title without touching IDs')
* it('accepts dependencyExternalIds array; defaults to []')

## `/api/tasks/[id]/import (POST)`

* it('rejects non-file payloads with 400')
* it('imports rows as subtasks under the given task')
* it('skips rows without Task title; reports created/skipped counts')
* it('converts Est. Time (min) to seconds on import')
* it('merges AC/How-to into description')
* it('maps priority aliases')
* it('preserves provided externalId; generates when missing')
* it('handles multiple-sheet workbooks (all rows → same target task in GUI)')
* it('returns 413/422 on extremely large/invalid files (if enforced)')

## `/api/tasks/[id] (GET)`

* it('returns task with subtasks ordered by createdAt ascending')
* it('does not include fields not requested (lean payload if you implement select)')

## `/api/search (GET)`

* it('returns tasks and subtasks matching title (case-insensitive)')
* it('returns tasks and subtasks matching externalId')
* it('limits results (take=10)')

---

# Middleware Tests

**describe('auth middleware')**

* it('redirects unauthenticated requests to /api/auth/signin with callbackUrl preserved')
* it('allows /api/auth/*, /_next/*, /public/*, /favicon.ico, and file extensions without redirect')
* it('accepts a valid JWT cookie and continues to page')
* it('uses the same secret as auth.ts (env parity test)')
* it('does not strip querystring on redirect')

---

# Integration Tests — With Real DB

*(Spin up a test Postgres, run Prisma migrations, use real Prisma client.)*

## Tasks/Subtasks lifecycle

* it('creating a task persists all fields, defaults state=""')
* it('moving task to Done sets closedAt timestamp (approx now)')
* it('logging hours accumulates decimal correctly (precision check)')
* it('editing fields round-trips correctly (notes, xp, estimatedSec, dependencyExternalIds)')
* it('creating subtask toggling completed sets/clears closedAt')

## Importer (GUI route)

* it('creates N subtasks and skips M in a provided workbook (fixture)')
* it('imports priority, state, status, xp, notes exactly')
* it('stores dependencies as text[] matching provided IDs')
* it('converts minutes to seconds consistently (large/random values)')
* it('handles duplicate externalId gracefully (fail or regenerate if you implemented that behavior)')

## CLI Importer (scripts/import-excel.ts)

* it('creates a task per sheet, subtasks per row, logs created/skipped')
* it('sheet title precedence over filename for main task')
* it('handles workbook without headers (rows skipped)')
* it('handles duplicate IDs (based on your collision policy)')

---

# Component Tests — React (Testing Library)

## `TaskCard`

* it('renders title and subtasks badge (done/total)')
* it('opens side pane on click (calls openPane with task)')
* it('does not start drag on simple click (activationConstraint)')
* it('double-click/inline edit title saves on blur/Enter (if still present)')

## `SubtaskList`

* it('renders subtasks with completed checkbox and editable title')
* it('calls onChange after add/toggle/edit with updated items')
* it('adds a new subtask on Add button, clears input, and re-renders')
* it('persists completion and reflects closedAt change (if surfaced)')

## `TaskPane`

* it('opens with task details; shows ID/state/status/priority/xp/est/notes/deps')
* it('patches description on blur')
* it('patches each metadata field on blur/change (priority dropdown, etc.)')
* it('updates logged hours on blur and reflects new value')
* it('shows subtasks list and live completion ratio')
* it('Import Subtasks button opens file picker; on upload success refreshes subtasks')

## `ProfileMenu`

* it('shows initials from name/email; displays email')
* it('shows session duration (e.g., "1h 23m" or "2d 4h") based on loginAt')
* it('logs out on click and redirects to /api/auth/signin')

## `Board`

* it('renders columns in order with tasks')
* it('onDragEnd with same column does nothing (no state change)')
* it('onDragEnd with different column removes from source and appends to target (optimistic)')
* it('sends reorder request with new columnId/position')

---

# Reporting Tests

**describe('/reports page calculations')**

* it('durationHours = max(0, (endAt - startAt)/3600000) with rounding to 2 decimals')
* it('loggedHours = task.logHours + Σ subtask.logHours')
* it('handles missing start/end/log hours as 0')
* it('subtasks column shows done/total correctly')

---

# Schema & Constraint Tests (Prisma-level)

* it('Task.externalId is unique, nullable allowed; same for Subtask.externalId')
* it('dependencyExternalIds defaults to [] when not provided')
* it('priority enum accepts only LOW/MEDIUM/HIGH/CRITICAL or null')
* it('notes and description store large text (no truncation)')
* it('Decimal precision for logHours meets expectations (e.g., 2 decimal places)')

---

# Property-Based / Fuzzy Tests (fast-check)

* **ID generator**: uniqueness and prefix invariants across 50k samples
* **Excel mapper**: random header casing/spacing → still maps correctly
* **Dependency field**: random punctuation/spacing → parser returns only non-empty tokens
* **Time conversions**: random minutes → seconds and back (hours rendering) remain consistent (tolerate rounding)

---

# Security & Edge Tests

* **Middleware**: path traversal attempts still redirect as expected; public files are never blocked
* **API**: reject giant multipart uploads (set and test a size limit if configured)
* **Auth**: mismatched secrets → session decode fails (expect redirect), matched secrets → success
* **XSS**: description fields rendered with markdown—verify sanitization strategy (or at least escaping in plain render)

---

# Sample Test Skeletons

```ts
// tests/unit/excel.spec.ts
import { loadXlsx } from "@/lib/excel";
import * as XLSX from "xlsx";

function wb(rows: any[], sheet = "Work") {
  const ws = XLSX.utils.json_to_sheet(rows);
  const w = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(w, ws, sheet);
  return XLSX.write(w, { type: "buffer", bookType: "xlsx" });
}

it("maps Est. Time (min) → seconds and merges description blocks", () => {
  const buf = wb([
    { Task: "Set up", "Est. Time (min)": 15, description: "Desc", "Acceptance Criteria": "AC", "Commands/How to Run": "Run" },
  ], "Setup Sheet");

  const sheets = loadXlsx(buf as Buffer, "file.xlsx");
  expect(sheets[0].mainTaskTitle).toBe("Setup Sheet");
  const r = sheets[0].rows[0]!;
  expect(r.estimatedSec).toBe(900);
  expect(r.description).toMatch(/Desc/);
  expect(r.description).toMatch(/Acceptance Criteria/);
  expect(r.description).toMatch(/How to Run/);
});
```

```ts
// tests/middleware/auth.middleware.spec.ts
import { middleware } from "@/../middleware";
import { NextRequest } from "next/server";

it("redirects unauthenticated to signin with callbackUrl", async () => {
  const url = new URL("http://localhost:3000/reports?x=1");
  const req = new NextRequest(url);
  const res = await middleware(req); // mock getToken to return null
  expect(res?.headers.get("location")).toContain("/api/auth/signin?callbackUrl=%2Freports%3Fx%3D1");
});
```

```ts
// tests/components/taskpane.spec.tsx
import { render, screen, fireEvent, waitFor } from "@testing-library/react";
import TaskPaneProvider from "@/components/TaskPaneProvider";
import TaskPane from "@/components/TaskPane";

it("edits fields and imports subtasks", async () => {
  // render provider + pane and open with a fake task
  // mock fetch for PATCH and import routes
});
```

---

# How to Run (example with Vitest)

**package.json**

```json
{
  "devDependencies": {
    "vitest": "^2.0.0",
    "@testing-library/react": "^14.0.0",
    "@testing-library/jest-dom": "^6.0.0",
    "fast-check": "^3.14.0",
    "supertest": "^7.0.0",
    "jsdom": "^24.0.0"
  },
  "scripts": {
    "test": "vitest --run",
    "test:watch": "vitest",
    "test:ui": "vitest --ui"
  }
}
```

`vitest.config.ts` (jsdom for component tests; node for unit/integration):

```ts
import { defineConfig } from "vitest/config";

export default defineConfig({
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./tests/setup.ts'],
    include: ['tests/**/*.spec.ts', 'tests/**/*.spec.tsx'],
  },
});
```

`tests/setup.ts`:

```ts
import '@testing-library/jest-dom';
```

---

